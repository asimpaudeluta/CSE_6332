<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Earthquake Queries</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='HW2.css') }}">
  <script>
  const lastQueryType = "{{ last_query_type or '' }}";
  const lastParams = {
    param1: "{{ last_params.param1 if last_params is defined else '' }}",
    param2: "{{ last_params.param2 if last_params is defined else '' }}",
    param3: "{{ last_params.param3 if last_params is defined else '' }}",
    param4: "{{ last_params.param4 if last_params is defined else '' }}",
    param5: "{{ last_params.param5 if last_params is defined else '' }}"
  };

  const paramFields = [
    { el: null, placeholder: "" },
    { el: null, placeholder: "" },
    { el: null, placeholder: "" },
    { el: null, placeholder: "" },
    { el: null, placeholder: "" }
  ];

  document.addEventListener("DOMContentLoaded", () => {
    // Link actual DOM elements to paramFields
    for (let i = 0; i < 5; i++) {
      paramFields[i].el = document.getElementsByName(`param${i + 1}`)[0];
    }

    // Set initial values from lastParams
    paramFields.forEach((p, idx) => {
      const key = `param${idx + 1}`;
      p.el.value = lastParams[key] || "";
    });

    // Set query type and show fields accordingly
    if (lastQueryType) {
      document.getElementById("query_type").value = lastQueryType;
      updateParams();
    }
  });

  function updateParams() {
    const type = document.getElementById("query_type").value;
    const paramGroups = document.querySelectorAll("#params .param-group");
    paramGroups.forEach(g => g.style.display = "none");
    for (let i = 1; i <= 5; i++) {
      document.getElementById(`label_param${i}`).textContent = "";
    }
    switch (type) {
      case "largest_n":
        document.getElementById("label_param1").textContent = "Number of earthquakes (N)";
        paramGroups[0].style.display = "block";
        break;

      case "buffer_quakes":
        document.getElementById("label_param1").textContent = "Latitude";
        document.getElementById("label_param2").textContent = "Longitude";
        document.getElementById("label_param3").textContent = "Buffer in km";
        paramGroups[0].style.display = "block";
        paramGroups[1].style.display = "block";
        paramGroups[2].style.display = "block";
        break;

      case "date_range":
        document.getElementById("label_param1").textContent = "Start date (YYYY-MM-DD)";
        document.getElementById("label_param2").textContent = "End date (YYYY-MM-DD)";
        document.getElementById("label_param3").textContent = "Minimum Magnitude";
        paramGroups[0].style.display = "block";
        paramGroups[1].style.display = "block";
        paramGroups[2].style.display = "block";
        break;

      case "count_by_mag":
        break;

      case "compare_regions":
        document.getElementById("label_param1").textContent = "Region A - Lat";
        document.getElementById("label_param2").textContent = "Region A - Lon";
        document.getElementById("label_param3").textContent = "Region B - Lat";
        document.getElementById("label_param4").textContent = "Region B - Lon";
        document.getElementById("label_param5").textContent = "Buffer in km";
        paramGroups.forEach(g => g.style.display = "block");
        break;

      case "largest_near":
        document.getElementById("label_param1").textContent = "Latitude";
        document.getElementById("label_param2").textContent = "Longitude";
        document.getElementById("label_param3").textContent = "Buffer in km";
        paramGroups[0].style.display = "block";
        paramGroups[1].style.display = "block";
        paramGroups[2].style.display = "block";
        break;
    }
  }

</script>
</head>
<body>
  <main class="container">
    <section class="left">
      <h3>Query Preview</h3>
      {% if query_results %}
        <table border="1" cellpadding="5" cellspacing="0">
          <thead>
            <tr>
              {% for col in column_names %}
              <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in query_results %}
            <tr>
              {% for item in row %}
              <td>{{ item }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% elif query_error %}
        <p style="color: red;"><strong>Error:</strong> {{ query_error }}</p>
      {% else %}
        <p>None.</p>
      {% endif %}
    </section>

    <section class="right">
      <h2>Download Earthquake CSV</h2>
        <p>
          <strong>Last updated:</strong>
            {{ last_download_time if last_download_time else "Not available" }}
        </p>

      <form id="download_data" method="POST" action="{{ url_for('download_data') }}">
        <button type="submit">Download and Upload CSV</button>
      </form>

      <h2>Run Predefined Query</h2>
      <form method="POST" action="{{ url_for('run_prepared_query') }}">
        <label for="query_type"><strong>Select a query:</strong></label>
        <select name="query_type" id="query_type" required onchange="updateParams()">
          <option value="">Select a query...</option>
          <option value="largest_n" {% if last_query_type == 'largest_n' %}selected{% endif %}>N largest earthquakes</option>
          <option value="buffer_quakes" {% if last_query_type == 'buffer_quakes' %}selected{% endif %}>Quakes within buffer of point</option>
          <option value="date_range" {% if last_query_type == 'date_range' %}selected{% endif %}>Quakes in date range</option>
          <option value="count_by_mag" {% if last_query_type == 'count_by_mag' %}selected{% endif %}>Count of quakes in last 3 days by magnitude</option>
          <option value="compare_regions" {% if last_query_type == 'compare_regions' %}selected{% endif %}>More common in region A or B</option>
          <option value="largest_near" {% if last_query_type == 'largest_near' %}selected{% endif %}>Largest near point</option>
        </select>
        <div id="params">
          <div class="param-group" style="display:none;">
            <label for="param1" id="label_param1"></label>
            <input type="text" name="param1" id="param1" value="{{ last_params.param1 if last_params is defined else '' }}">
          </div>
          <div class="param-group" style="display:none;">
            <label for="param2" id="label_param2"></label>
            <input type="text" name="param2" id="param2" value="{{ last_params.param2 if last_params is defined else '' }}">
          </div>
          <div class="param-group" style="display:none;">
            <label for="param3" id="label_param3"></label>
            <input type="text" name="param3" id="param3" value="{{ last_params.param3 if last_params is defined else '' }}">
          </div>
          <div class="param-group" style="display:none;">
            <label for="param4" id="label_param4"></label>
            <input type="text" name="param4" id="param4" value="{{ last_params.param4 if last_params is defined else '' }}">
          </div>
          <div class="param-group" style="display:none;">
            <label for="param5" id="label_param5"></label>
            <input type="text" name="param5" id="param5" value="{{ last_params.param5 if last_params is defined else '' }}">
          </div>
        </div>
        <button type="submit">Run</button>
      </form> <!-- This approach ended up being worse (longer) than many functions in flask -->

      <h2>Run Custom SQL Query</h2>
      <form method="POST" action="{{ url_for('run_query') }}">
        <textarea name="sql_query" rows="1" style="width:100%; height: 50px;" placeholder="SELECT * FROM Earthquakes">{{ last_query }}</textarea>
        <br><br>
        <button type="submit">Execute Query</button>
      </form>
    </section>
  </main>
</body>
</html>


