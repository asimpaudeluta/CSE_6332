<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quiz 3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='Qz3.css') }}">
  <script>
  const lastQueryType = "{{ last_query_type or '' }}";
  const lastParams = {
    param1: "{{ last_params.param1 if last_params is defined else '' }}",
    param2: "{{ last_params.param2 if last_params is defined else '' }}",
    param3: "{{ last_params.param3 if last_params is defined else '' }}",
    param4: "{{ last_params.param4 if last_params is defined else '' }}",
    param5: "{{ last_params.param5 if last_params is defined else '' }}"
  };

  const paramFields = [
    { el: null, placeholder: "" },
    { el: null, placeholder: "" },
    { el: null, placeholder: "" },
    { el: null, placeholder: "" },
    { el: null, placeholder: "" }
  ];

  document.addEventListener("DOMContentLoaded", () => {
    // Link actual DOM elements to paramFields
    for (let i = 0; i < 5; i++) {
      paramFields[i].el = document.getElementsByName(`param${i + 1}`)[0];
    }

    // Set initial values from lastParams
    paramFields.forEach((p, idx) => {
      const key = `param${idx + 1}`;
      p.el.value = lastParams[key] || "";
    });

    // Set query type and show fields accordingly
    if (lastQueryType) {
      document.getElementById("query_type").value = lastQueryType;
      updateParams();
    }
  });

  function updateParams() {
    const type = document.getElementById("query_type").value;
    const paramGroups = document.querySelectorAll("#params .param-group");
    paramGroups.forEach(g => g.style.display = "none");
    for (let i = 1; i <= 5; i++) {
      document.getElementById(`label_param${i}`).textContent = "";
    }
    switch (type) {
      case "mag_range":
        document.getElementById("label_param1").textContent = "Min Mag";
        document.getElementById("label_param2").textContent = "Max Mag";
        paramGroups[0].style.display = "block";
        paramGroups[1].style.display = "block";
        break;

      case "buffer_quakes":
        document.getElementById("label_param1").textContent = "Min Mag";
        document.getElementById("label_param2").textContent = "Max Mag";
        document.getElementById("label_param3").textContent = "Latitude";
        document.getElementById("label_param4").textContent = "Longitude";
        document.getElementById("label_param5").textContent = "Buffer in degrees";
        paramGroups[0].style.display = "block";
        paramGroups[1].style.display = "block";
        paramGroups[2].style.display = "block";
        paramGroups[3].style.display = "block";
        paramGroups[4].style.display = "block";
        paramGroups[5].style.display = "block";
        break;
    }
  }

</script>
</head>
<body>
  <main class="container">
    <section class="left">
      <img src="{{ url_for('get_image') }}" alt="User Image" style="max-width: 100%; height: auto; border: 1px solid #ccc; padding: 5px;">
      <h1>Asim Paudel (1002122407)</h1>
      <h3>Query Preview</h3>
      {% if query_results %}
        <table border="1" cellpadding="5" cellspacing="0">
          <thead>
            <tr>
              {% for col in column_names %}
              <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in query_results %}
            <tr>
              {% for item in row %}
              <td>{{ item }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% elif query_error %}
        <p style="color: red;"><strong>Error:</strong> {{ query_error }}</p>
      {% else %}
        <p>None.</p>
      {% endif %}
    </section>

    <section class="right">
      <h2>Convert data-1.csv to SQLite DB</h2>
        <p>
          <strong>Last updated:</strong>
            {{ last_download_time if last_download_time else "Not available" }}
        </p>

      <form id="download_data" method="POST" action="{{ url_for('download_data') }}">
        <button type="submit">Create SQLite DB</button>
      </form>

      <h5>Qz3: 12, 13</h5>
      <form method="POST" action="{{ url_for('run_prepared_query') }}">
        <label for="query_type"><strong>Select a query:</strong></label>
        <select name="query_type" id="query_type" required onchange="updateParams()">
          <option value="">Select a query...</option>
          <option value="mag_range" {% if last_query_type == 'mag_range' %}selected{% endif %}>12. Quakes within Mag Range</option>
          <option value="buffer_quakes" {% if last_query_type == 'buffer_quakes' %}selected{% endif %}>13. Quakes within buffer of point</option>
        </select>
        <div id="params">
          <div class="param-group" style="display:none;">
            <label for="param1" id="label_param1"></label>
            <input type="text" name="param1" id="param1" value="{{ last_params.param1 if last_params is defined else '' }}">
          </div>
          <div class="param-group" style="display:none;">
            <label for="param2" id="label_param2"></label>
            <input type="text" name="param2" id="param2" value="{{ last_params.param2 if last_params is defined else '' }}">
          </div>
          <div class="param-group" style="display:none;">
            <label for="param3" id="label_param3"></label>
            <input type="text" name="param3" id="param3" value="{{ last_params.param3 if last_params is defined else '' }}">
          </div>
          <div class="param-group" style="display:none;">
            <label for="param4" id="label_param4"></label>
            <input type="text" name="param4" id="param4" value="{{ last_params.param4 if last_params is defined else '' }}">
          </div>
          <div class="param-group" style="display:none;">
            <label for="param5" id="label_param5"></label>
            <input type="text" name="param5" id="param5" value="{{ last_params.param5 if last_params is defined else '' }}">
          </div>
        </div>
        <button type="submit">Run</button>
      </form> <!-- This approach ended up being worse (longer) than many functions in flask -->

      <h5>14. Allow a user to specify a net value on a form, first count the number of occurrences for that value, then delete all of those entries. Show how many entries remain.</h5>
        <form method="POST" action="{{ url_for('delete_by_net') }}">
          <label for="net_value">Enter Net value to delete:</label>
          <input type="text" id="net_value" name="net_value" required>
          <button type="submit">Delete by Net</button>
        </form>
      <h5> 15. Allow a user to create a new tuple with all attributes, check to ensure that the id does not already exist (if it does give an error message)</h5>
        <form method="POST" action="{{ url_for('insert_row') }}">
          <label>Time (epoch):</label>
          <input type="text" name="time" required><br>

          <label>Latitude:</label>
          <input type="text" name="lat" required><br>

          <label>Longitude:</label>
          <input type="text" name="long" required><br>

          <label>Magnitude:</label>
          <input type="text" name="mag" required><br>

          <label>Number of stations (nst):</label>
          <input type="text" name="nst" required><br>

          <label>Net:</label>
          <input type="text" name="net" required><br>

          <label>ID (unique):</label>
          <input type="text" name="id" required><br>

          <button type="submit">Insert Row</button>
        </form>

      <h5> 16. Allow a user to enter a net id (if it exists) or a time and modify any of the attributes.</h5>
        <form method="POST" action="{{ url_for('update_row') }}">
  <p><strong>Identify Row to Update (Provide either ID or Time):</strong></p>
  <label>ID:</label>
  <input type="text" name="target_id"><br>
  <label>OR Time (epoch):</label>
  <input type="text" name="target_time"><br>

  <p><strong>Fields to Update (leave blank to skip):</strong></p>
  <label>Latitude:</label>
  <input type="text" name="lat"><br>

  <label>Longitude:</label>
  <input type="text" name="long"><br>

  <label>Magnitude:</label>
  <input type="text" name="mag"><br>

  <label>Number of stations (nst):</label>
  <input type="text" name="nst"><br>

  <label>Net:</label>
  <input type="text" name="net"><br>

  <button type="submit">Update Row</button>
</form>

      {% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul style="color: green;">
      {% for msg in messages %}
        <li>{{ msg }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}
    </section>
  </main>
</body>
</html>


