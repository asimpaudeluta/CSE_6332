<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quiz 3</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="{{ url_for('static', filename='Qz3.css') }}">
<script>
    const lastQueryType="{{ last_query_type or '' }}";const lastParams={param1:"{{ last_params.param1 if last_params is defined else '' }}",param2:"{{ last_params.param2 if last_params is defined else '' }}",param3:"{{ last_params.param3 if last_params is defined else '' }}",param4:"{{ last_params.param4 if last_params is defined else '' }}",param5:"{{ last_params.param5 if last_params is defined else '' }}"};
    function hideAllQ10(){const g=document.querySelectorAll("#params .param-group");g.forEach(x=>x.style.display="none");for(let i=1;i<=3;i++){document.getElementById("label_param"+i).textContent="";document.getElementById("param"+i).value=document.getElementById("param"+i).value||""}}
    function updateParamsQ10(){hideAllQ10();const t=document.getElementById("query_type").value;if(t==="time_range"){document.querySelectorAll("#params .param-group")[0].style.display="block";document.querySelector("#label_param1").textContent="Min Time (e.g., 18020)";document.querySelectorAll("#params .param-group")[1].style.display="block";document.querySelector("#label_param2").textContent="Max Time (e.g., 18060)"}else if(t==="start_net_count"){document.querySelectorAll("#params .param-group")[0].style.display="block";document.querySelector("#label_param1").textContent="Start Time (e.g., 15560)";document.querySelectorAll("#params .param-group")[1].style.display="block";document.querySelector("#label_param2").textContent="Net (e.g., ak)";document.querySelectorAll("#params .param-group")[2].style.display="block";document.querySelector("#label_param3").textContent="Count C (e.g., 3)"}}
    async function resetAndLoad(){const blobName=document.getElementById("blob_name").value.trim()||"dataset.csv";const r=await fetch("/load_dataset_reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({blob_name:blobName})});const j=await r.json();document.getElementById("reset_load_out").textContent=JSON.stringify(j,null,2)}
    async function runQ11(){const payload={T:Number(document.getElementById("q11_T").value||1),q10a:{min_time:Number(document.getElementById("q11_a_min").value),max_time:Number(document.getElementById("q11_a_max").value)},q10b:{start_time:Number(document.getElementById("q11_b_start").value),net:document.getElementById("q11_b_net").value.trim(),count:Number(document.getElementById("q11_b_count").value||1)}};const r=await fetch("/Qz3/q11",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});const j=await r.json();document.getElementById("q11_out").textContent=JSON.stringify(j,null,2)}
    async function runQ12(){const get=id=>document.getElementById(id).value.trim();const updates={};if(get("q12_lat"))updates.latitude=get("q12_lat");if(get("q12_lon"))updates.longitude=get("q12_lon");if(get("q12_depth"))updates.depth=get("q12_depth");if(get("q12_mag"))updates.mag=get("q12_mag");if(get("q12_net"))updates.net=get("q12_net");if(get("q12_id"))updates.id=get("q12_id");if(get("q12_time_new"))updates.time=get("q12_time_new");const payload={time:Number(document.getElementById("q12_time").value),updates};const r=await fetch("/Qz3/q12_update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});const j=await r.json();document.getElementById("q12_out").textContent=JSON.stringify(j,null,2)}
    async function runQ10a_cached(){const payload={min_time:Number(document.getElementById("q11_a_min").value),max_time:Number(document.getElementById("q11_a_max").value)};const r=await fetch("/Qz3/q10a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});const j=await r.json();document.getElementById("q13_a_out").textContent=JSON.stringify(j,null,2)}
    async function runQ10b_cached(){const payload={start_time:Number(document.getElementById("q11_b_start").value),net:document.getElementById("q11_b_net").value.trim(),count:Number(document.getElementById("q11_b_count").value)};const r=await fetch("/Qz3/q10b",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});const j=await r.json();document.getElementById("q13_b_out").textContent=JSON.stringify(j,null,2)}
    async function runQ11_cached(){const payload={T:Number(document.getElementById("q11_T").value||1),q10a:{min_time:Number(document.getElementById("q11_a_min").value),max_time:Number(document.getElementById("q11_a_max").value)},q10b:{start_time:Number(document.getElementById("q11_b_start").value),net:document.getElementById("q11_b_net").value.trim(),count:Number(document.getElementById("q11_b_count").value||1)}};const r=await fetch("/Qz3/q11",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});const j=await r.json();document.getElementById("q13_11_out").textContent=JSON.stringify(j,null,2)}
    async function refreshCacheStats(){const r=await fetch("/Qz3/q13_stats");const j=await r.json();document.getElementById("q13_stats").textContent=JSON.stringify(j,null,2)}
    document.addEventListener("DOMContentLoaded",()=>{for(let i=1;i<=5;i++){const el=document.getElementsByName(`param${i}`)[0];if(el){const key=`param${i}`;el.value=lastParams[key]||""}};if(lastQueryType){const sel=document.getElementById("query_type");if(sel){sel.value=lastQueryType}}updateParamsQ10()})
</script>
</head>
<body>
    <main class="container">
    <section class="left">
        <h1>Asim Paudel (1002122407)</h1>
        <h3>Query Preview</h3>
        {% if query_results %}
        <table border="1" cellpadding="5" cellspacing="0"><thead><tr>{% for col in column_names %}<th>{{ col }}</th>{% endfor %}</tr></thead><tbody>{% for row in query_results %}<tr>{% for item in row %}<td>{{ item }}</td>{% endfor %}</tr>{% endfor %}</tbody></table>
        {% elif query_error %}
        <p style="color:red;"><strong>Error:</strong> {{ query_error }}</p>
        {% else %}
        <p>None.</p>
        {% endif %}
    </section>
    <section class="right">
        <h2>Load dataset.csv to Azure SQL (reset table)</h2>
        <p><strong>Note:</strong> This will DROP and recreate <code>dbo.quakes</code>, then load rows from your blob: <code>{{ dir }}/dataset.csv</code>.</p>
        <form onsubmit="event.preventDefault();resetAndLoad();"><label>CSV Blob Name:</label><input id="blob_name" value="dataset.csv"><button type="submit">Reset & Load</button></form>
        <pre id="reset_load_out" style="background:#111;color:#eee;padding:1rem;border-radius:8px;white-space:pre-wrap;"></pre>
        <h5>Qz3: 10a, 10b</h5>
        <form method="POST" action="{{ url_for('run_prepared_query') }}">
        <label for="query_type"><strong>Select a query:</strong></label>
        <select name="query_type" id="query_type" required onchange="updateParamsQ10()">
        <option value="">Select a query...</option>
        <option value="time_range" {% if last_query_type == 'time_range' %}selected{% endif %}>10(a). Quakes within Time Range</option>
        <option value="start_net_count" {% if last_query_type == 'start_net_count' %}selected{% endif %}>10(b). First C events at a Net starting at Time</option>
        </select>
        <div id="params">
        <div class="param-group" style="display:none;"><label for="param1" id="label_param1"></label><input type="text" name="param1" id="param1" value="{{ last_params.param1 if last_params is defined else '' }}"></div>
        <div class="param-group" style="display:none;"><label for="param2" id="label_param2"></label><input type="text" name="param2" id="param2" value="{{ last_params.param2 if last_params is defined else '' }}"></div>
        <div class="param-group" style="display:none;"><label for="param3" id="label_param3"></label><input type="text" name="param3" id="param3" value="{{ last_params.param3 if last_params is defined else '' }}"></div>
        </div>
        <button type="submit">Run</button>
        </form>
        {% if timing_ms is defined %}<p><em>Query time:</em> {{ timing_ms }} ms</p>{% endif %}
        <h5>Qz3: 11) Repeat Both Queries T Times</h5>
        <div style="display:grid;gap:.5rem;max-width:520px">
        <label>Times (T)<input id="q11_T" type="number" value="3" min="1" step="1"></label>
        <fieldset style="border:1px solid #ccc;padding:.75rem"><legend>10(a) — Time Range</legend><label>Min Time <input id="q11_a_min" type="number" value="18020"></label><label>Max Time <input id="q11_a_max" type="number" value="18060"></label></fieldset>
        <fieldset style="border:1px solid #ccc;padding:.75rem"><legend>10(b) — Start Time + Net + Count</legend><label>Start Time <input id="q11_b_start" type="number" value="15560"></label><label>Net <input id="q11_b_net" type="text" value="ak"></label><label>Count C <input id="q11_b_count" type="number" value="3" min="1" step="1"></label></fieldset>
        <button onclick="runQ11()">Run 11</button>
        </div>
        <pre id="q11_out" style="background:#111;color:#eee;padding:1rem;border-radius:8px;white-space:pre-wrap;max-height:380px;overflow:auto"></pre>
        <hr>
    <section>
        <h5>Qz3: 12) Update by Time</h5>
        <div style="display:grid;gap:.5rem;max-width:520px">
        <label>Time (existing row) <input id="q12_time" type="number" value="20160"></label>
        <details><summary>Attributes to Modify (leave blank to skip)</summary><div style="display:grid;gap:.4rem;margin-top:.5rem"><label>latitude <input id="q12_lat" type="text" placeholder="e.g., 38.8267"></label><label>longitude <input id="q12_lon" type="text" placeholder="-122.7693"></label><label>depth <input id="q12_depth" type="text" placeholder="2.87"></label><label>mag <input id="q12_mag" type="text" placeholder="1.23"></label><label>net <input id="q12_net" type="text" placeholder="nc"></label><label>id <input id="q12_id" type="text" placeholder="(optional)"></label><label>time <input id="q12_time_new" type="text" placeholder="(optional: change time)"></label></div></details>
        <button onclick="runQ12()">Run 12 (Update)</button>
        </div>
        <pre id="q12_out" style="background:#111;color:#eee;padding:1rem;border-radius:8px;white-space:pre-wrap;max-height:260px;overflow:auto"></pre>
    </section>
    <hr>
    <section>
        <h5>Qz3: 13) Cache-Backed Queries + Stats</h5>
        <p style="margin:.25rem 0 .5rem">Use the same inputs as Q10/Q11 above. The backend uses Redis caching.</p>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem">
        <button onclick="runQ10a_cached()">Run 10(a) (cached)</button>
        <button onclick="runQ10b_cached()">Run 10(b) (cached)</button>
        <button onclick="runQ11_cached()">Run 11 (cached)</button>
        <button onclick="refreshCacheStats()">Show Cache Stats</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr;gap:.5rem">
        <pre id="q13_a_out" style="background:#111;color:#eee;padding:1rem;border-radius:8px;white-space:pre-wrap;max-height:200px;overflow:auto"></pre>
        <pre id="q13_b_out" style="background:#111;color:#eee;padding:1rem;border-radius:8px;white-space:pre-wrap;max-height:200px;overflow:auto"></pre>
        <pre id="q13_11_out" style="background:#111;color:#eee;padding:1rem;border-radius:8px;white-space:pre-wrap;max-height:260px;overflow:auto"></pre>
        <pre id="q13_stats" style="background:#111;color:#eee;padding:1rem;border-radius:8px;white-space:pre-wrap;max-height:220px;overflow:auto"></pre>
        </div>
    </section>
    </section>
    </main>
</body>
</html>
