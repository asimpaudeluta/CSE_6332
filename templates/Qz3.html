<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quiz 3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='Qz3.css') }}">
  <script>
  const lastQueryType = "{{ last_query_type or '' }}";
  const lastParams = {
    param1: "{{ last_params.param1 if last_params is defined else '' }}",
    param2: "{{ last_params.param2 if last_params is defined else '' }}",
    param3: "{{ last_params.param3 if last_params is defined else '' }}",
    param4: "{{ last_params.param4 if last_params is defined else '' }}",
    param5: "{{ last_params.param5 if last_params is defined else '' }}"
  };

  const paramFields = [
    { el: null, placeholder: "" },
    { el: null, placeholder: "" },
    { el: null, placeholder: "" },
    { el: null, placeholder: "" },
    { el: null, placeholder: "" }
  ];

  document.addEventListener("DOMContentLoaded", () => {
    // Link actual DOM elements to paramFields
    for (let i = 0; i < 5; i++) {
      paramFields[i].el = document.getElementsByName(`param${i + 1}`)[0];
    }

    // Set initial values from lastParams
    paramFields.forEach((p, idx) => {
      const key = `param${idx + 1}`;
      p.el.value = lastParams[key] || "";
    });

    // Set query type and show fields accordingly
    if (lastQueryType) {
      document.getElementById("query_type").value = lastQueryType;
      updateParams();
    }
  });

  function updateParams() {
    const type = document.getElementById("query_type").value;
    const paramGroups = document.querySelectorAll("#params .param-group");
    paramGroups.forEach(g => g.style.display = "none");
    for (let i = 1; i <= 5; i++) {
      document.getElementById(`label_param${i}`).textContent = "";
    }
    switch (type) {
      case "mag_range":
        document.getElementById("label_param1").textContent = "Min Mag";
        document.getElementById("label_param2").textContent = "Max Mag";
        paramGroups[0].style.display = "block";
        paramGroups[1].style.display = "block";
        break;

      case "buffer_quakes":
        document.getElementById("label_param1").textContent = "Min Mag";
        document.getElementById("label_param2").textContent = "Max Mag";
        document.getElementById("label_param3").textContent = "Latitude";
        document.getElementById("label_param4").textContent = "Longitude";
        document.getElementById("label_param5").textContent = "Buffer in degrees";
        paramGroups[0].style.display = "block";
        paramGroups[1].style.display = "block";
        paramGroups[2].style.display = "block";
        paramGroups[3].style.display = "block";
        paramGroups[4].style.display = "block";
        paramGroups[5].style.display = "block";
        break;
    }
  }

</script>
</head>
<body>
  <main class="container">
    <section class="left">
      <h1>Asim Paudel (1002122407)</h1>
      <h3>Query Preview</h3>
      {% if query_results %}
        <table border="1" cellpadding="5" cellspacing="0">
          <thead>
            <tr>
              {% for col in column_names %}
              <th>{{ col }}</th>
              {% endfor g%}
            </tr>
          </thead>
          <tbody>
            {% for row in query_results %}
            <tr>
              {% for item in row %}
              <td>{{ item }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% elif query_error %}
        <p style="color: red;"><strong>Error:</strong> {{ query_error }}</p>
      {% else %}
        <p>None.</p>
      {% endif %}
    </section>

    <section class="right">
      <h2>Load dataset.csv to Azure SQL (reset table)</h2>
      <p>
        <strong>Note:</strong> This will DROP and recreate <code>dbo.quakes</code>, then load rows from your blob: <code>{{ dir }}/dataset.csv</code>.
      </p>

      <form onsubmit="event.preventDefault(); resetAndLoad();">
        <label>CSV Blob Name:</label>
        <input id="blob_name" value="dataset.csv">
        <button type="submit">Reset & Load</button>
      </form>

      <pre id="reset_load_out" style="background:#111;color:#eee;padding:1rem;border-radius:8px;white-space:pre-wrap;"></pre>

    <script>
    async function resetAndLoad(){
      const blobName = document.getElementById('blob_name').value.trim() || 'dataset.csv';
      const r = await fetch("/load_dataset_reset", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ blob_name: blobName })
      });
      const j = await r.json();
      document.getElementById('reset_load_out').textContent = JSON.stringify(j, null, 2);
    }
    </script>

<h5>Qz3: 10a, 10b</h5>
<form method="POST" action="{{ url_for('run_prepared_query') }}">
  <label for="query_type"><strong>Select a query:</strong></label>
  <select name="query_type" id="query_type" required onchange="updateParamsQ10()">
    <option value="">Select a query...</option>
    <option value="time_range" {% if last_query_type == 'time_range' %}selected{% endif %}>
      10(a). Quakes within Time Range
    </option>
    <option value="start_net_count" {% if last_query_type == 'start_net_count' %}selected{% endif %}>
      10(b). First C events at a Net starting at Time
    </option>
  </select>

  <div id="params">
    <div class="param-group" style="display:none;">
      <label for="param1" id="label_param1"></label>
      <input type="text" name="param1" id="param1" value="{{ last_params.param1 if last_params is defined else '' }}">
    </div>
    <div class="param-group" style="display:none;">
      <label for="param2" id="label_param2"></label>
      <input type="text" name="param2" id="param2" value="{{ last_params.param2 if last_params is defined else '' }}">
    </div>
    <!-- param3 -->
    <div class="param-group" style="display:none;">
      <label for="param3" id="label_param3"></label>
      <input type="text" name="param3" id="param3" value="{{ last_params.param3 if last_params is defined else '' }}">
    </div>
  </div>

  <button type="submit">Run</button>
</form>

{% if timing_ms is defined %}
  <p><em>Query time:</em> {{ timing_ms }} ms</p>
{% endif %}

<script>
function hideAllQ10() {
  const groups = document.querySelectorAll("#params .param-group");
  groups.forEach(g => g.style.display = "none");
  for (let i=1;i<=3;i++) {
    document.getElementById('label_param'+i).textContent = "";
    document.getElementById('param'+i).value = document.getElementById('param'+i).value || "";
  }
}
function updateParamsQ10() {
  hideAllQ10();
  const t = document.getElementById("query_type").value;
  if (t === "time_range") {
    document.querySelectorAll("#params .param-group")[0].style.display = "block";
    document.querySelector("#label_param1").textContent = "Min Time (e.g., 18020)";
    document.querySelectorAll("#params .param-group")[1].style.display = "block";
    document.querySelector("#label_param2").textContent = "Max Time (e.g., 18060)";
  } else if (t === "start_net_count") {
    document.querySelectorAll("#params .param-group")[0].style.display = "block";
    document.querySelector("#label_param1").textContent = "Start Time (e.g., 15560)";
    document.querySelectorAll("#params .param-group")[1].style.display = "block";
    document.querySelector("#label_param2").textContent = "Net (e.g., ak)";
    document.querySelectorAll("#params .param-group")[2].style.display = "block";
    document.querySelector("#label_param3").textContent = "Count C (e.g., 3)";
  }
}
document.addEventListener("DOMContentLoaded", updateParamsQ10);
</script>
    </section>
  </main>
</body>
</html>


